#!/bin/bash
# Hook pre-commit pour CryptoSpreadEdge

echo "üîç V√©rification pre-commit..."

# V√©rifier que nous sommes dans un environnement conda
if [[ -z "$CONDA_DEFAULT_ENV" ]]; then
    echo "‚ö†Ô∏è  Aucun environnement conda activ√©"
    echo "üí° Activez l'environnement avec: conda activate cryptospreadedge-dev"
fi

# V√©rifier les imports Python
echo "üêç V√©rification des imports Python..."
python -c "
import sys
try:
    import fastapi, ccxt, pandas, numpy
    print('‚úÖ Imports principaux OK')
except ImportError as e:
    print(f'‚ùå Import manquant: {e}')
    sys.exit(1)
"

if [ $? -ne 0 ]; then
    echo "‚ùå Erreur d'import Python"
    exit 1
fi

# V√©rifier la syntaxe Python
echo "üîç V√©rification de la syntaxe Python..."
python -m py_compile src/main.py
if [ $? -ne 0 ]; then
    echo "‚ùå Erreur de syntaxe Python"
    exit 1
fi

# V√©rifier les fichiers de configuration
echo "‚öôÔ∏è  V√©rification des fichiers de configuration..."
if [ ! -f "config/environments/.env" ]; then
    echo "‚ö†Ô∏è  Fichier .env manquant, copie depuis l'exemple..."
    cp config/environments/env.example config/environments/.env
fi

# V√©rifier les secrets
echo "üîê V√©rification des secrets..."
if grep -q "your_.*_key" config/environments/.env; then
    echo "‚ö†Ô∏è  Cl√©s API par d√©faut d√©tect√©es dans .env"
    echo "üí° Configurez vos vraies cl√©s API avant de commiter"
fi

# V√©rifier la taille des fichiers
echo "üìè V√©rification de la taille des fichiers..."
large_files=$(find . -name "*.py" -size +1M)
if [ -n "$large_files" ]; then
    echo "‚ö†Ô∏è  Fichiers Python volumineux d√©tect√©s:"
    echo "$large_files"
fi

# V√©rifier les fichiers binaires
echo "üìÅ V√©rification des fichiers binaires..."
binary_files=$(git diff --cached --name-only | xargs file | grep -E "(binary|executable)")
if [ -n "$binary_files" ]; then
    echo "‚ö†Ô∏è  Fichiers binaires d√©tect√©s dans le commit:"
    echo "$binary_files"
fi

echo "‚úÖ V√©rifications pre-commit termin√©es"